<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Hugo 0.70.0" />
    <meta name="description" content="">


    <link rel="icon" href="../../images/favicon.png" type="image/png">

    <title>Labo 3: Introductie in GBA Programming :: Software Ontwerp in C(&#43;&#43;)</title>

    
    <link href="../../css/nucleus.css?1602585869" rel="stylesheet">
    <link href="../../css/fontawesome-all.min.css?1602585869" rel="stylesheet">
    <link href="../../css/hybrid.css?1602585869" rel="stylesheet">
    <link href="../../css/featherlight.min.css?1602585869" rel="stylesheet">
    <link href="../../css/perfect-scrollbar.min.css?1602585869" rel="stylesheet">
    <link href="../../css/auto-complete.css?1602585869" rel="stylesheet">
    <link href="../../css/atom-one-dark-reasonable.css?1602585869" rel="stylesheet">
    <link href="../../css/theme.css?1602585869" rel="stylesheet">
    <link href="../../css/hugo-theme.css?1602585869" rel="stylesheet">
    
    <link href="../../css/theme-kul.css?1602585869" rel="stylesheet">
    
    

    <script src="../../js/jquery-3.3.1.min.js?1602585869"></script>

    <style>
      :root #header + #content > #left > #rlblock_left{
          display:none !important;
      }
      
        :not(pre) > code + span.copy-to-clipboard {
            display: none;
        }
      
    </style>
      <script id="MathJax-script" async
          src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
  </script>

<script>
window.MathJax = {
  chtml: {
    scale: 2,                      
    minScale: .5,                  
    matchFontHeight: true,         
    mtextInheritFont: false,       
    merrorInheritFont: true,       
    mathmlSpacing: false,          
    skipAttributes: {},            
    exFactor: .5,                  
    displayAlign: 'center',        
    displayIndent: '0'             
  }
};
</script>

<script src=../../js/osc.js></script>
  </head>
  <body class="" data-url="/gba-in-c/labo-3/">
    <nav id="sidebar" class="">



  <div id="header-wrapper">
    <div id="header">
      <a href="https://www.kuleuven.be/kuleuven/" target="_blank">
	<img src="../../img/style/kul.png" alt="KU Leuven" /><br/>
</a>
<a href="https://www.uhasselt.be/" target="_blank">
	<img src="../../img/style/uhasselt.svg" alt="UHasselt" id="uhlogo" />
</a>
    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fas fa-search"></i></label>
    <input data-search-input id="search-by" type="search" placeholder="Search...">
    <span data-search-clear=""><i class="fas fa-times"></i></span>
</div>

<script type="text/javascript" src="../../js/lunr.min.js?1602585869"></script>
<script type="text/javascript" src="../../js/auto-complete.js?1602585869"></script>
<script type="text/javascript">
    
        var baseurl = "https:\/\/kuleuven-diepenbeek.github.io\/cpp-course\/";
    
</script>
<script type="text/javascript" src="../../js/search.js?1602585869"></script>

    
  </div>

    <div class="highlightable">
    <h3><a href="../../">Inhoudsopgave</a></h3>
    <ul class="topics">
        
          
          




 
  
    
    <li data-nav-id="/hoorcolleges/" title="Hoorcolleges" class="dd-item 
        
        
        
        ">
      <a href="../../hoorcolleges/">
          Hoorcolleges
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            




 
  
    
      <li data-nav-id="/hoorcolleges/slides-1/" title="1. Introductie in C/C&#43;&#43;: context, ecosysteem" class="dd-item ">
        <a href="../../hoorcolleges/slides-1/">
        1. Introductie in C/C&#43;&#43;: context, ecosysteem
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/hoorcolleges/slides-2/" title="2. Pointers in C, dynamisch geheugen in C&#43;&#43;" class="dd-item ">
        <a href="../../hoorcolleges/slides-2/">
        2. Pointers in C, dynamisch geheugen in C&#43;&#43;
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/hoorcolleges/slides-3/" title="3. Introductie in Object-Georiënteerd denken in C&#43;&#43;" class="dd-item ">
        <a href="../../hoorcolleges/slides-3/">
        3. Introductie in Object-Georiënteerd denken in C&#43;&#43;
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/hoorcolleges/slides-4/" title="4. Een introductie in GUI ontwerp met Qt, Samenvatting, examen info" class="dd-item ">
        <a href="../../hoorcolleges/slides-4/">
        4. Een introductie in GUI ontwerp met Qt, Samenvatting, examen info
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/c/" title="1. Introductie in C" class="dd-item 
        
        
        
        ">
      <a href="../../c/">
          1. Introductie in C
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            




 
  
    
      <li data-nav-id="/c/prep/" title="Voorbereiding Thuis" class="dd-item ">
        <a href="../../c/prep/">
        Voorbereiding Thuis
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/c/labo-1/" title="Labo 1: Introductie in C" class="dd-item ">
        <a href="../../c/labo-1/">
        Labo 1: Introductie in C
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/c/labo-2/" title="Labo 2: Pointers in C en C&#43;&#43;" class="dd-item ">
        <a href="../../c/labo-2/">
        Labo 2: Pointers in C en C&#43;&#43;
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/c/stack-vs-heap/" title="Labo 2b: De stack VS de heap" class="dd-item ">
        <a href="../../c/stack-vs-heap/">
        Labo 2b: De stack VS de heap
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/gba-in-c/" title="2. GBA programming in C" class="dd-item 
        parent
        
        
        ">
      <a href="../../gba-in-c/">
          2. GBA programming in C
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            




 
  
    
      <li data-nav-id="/gba-in-c/prep/" title="Voorbereiding Thuis" class="dd-item ">
        <a href="../../gba-in-c/prep/">
        Voorbereiding Thuis
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/gba-in-c/labo-3/" title="Labo 3: Introductie in GBA Programming" class="dd-item active">
        <a href="../../gba-in-c/labo-3/">
        Labo 3: Introductie in GBA Programming
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/gba-in-c/labo-4/" title="Labo 4: GBA Tilesets, een simpel spel" class="dd-item ">
        <a href="../../gba-in-c/labo-4/">
        Labo 4: GBA Tilesets, een simpel spel
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/cpp/" title="3. Introductie in C&#43;&#43;" class="dd-item 
        
        
        
        ">
      <a href="../../cpp/">
          3. Introductie in C&#43;&#43;
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            




 
  
    
      <li data-nav-id="/cpp/prep/" title="Voorbereiding Thuis" class="dd-item ">
        <a href="../../cpp/prep/">
        Voorbereiding Thuis
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/cpp/labo-5/" title="Labo 5: Weg met C, Hallo C&#43;&#43;" class="dd-item ">
        <a href="../../cpp/labo-5/">
        Labo 5: Weg met C, Hallo C&#43;&#43;
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/cpp/labo-6/" title="Labo 6: C&#43;&#43; Class Inheritance, operators en templates" class="dd-item ">
        <a href="../../cpp/labo-6/">
        Labo 6: C&#43;&#43; Class Inheritance, operators en templates
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/cpp/labo-7/" title="Labo 7: Software ontwerpen" class="dd-item ">
        <a href="../../cpp/labo-7/">
        Labo 7: Software ontwerpen
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/gba-in-cpp/" title="4. GBA Programming in C&#43;&#43;" class="dd-item 
        
        
        
        ">
      <a href="../../gba-in-cpp/">
          4. GBA Programming in C&#43;&#43;
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            




 
  
    
      <li data-nav-id="/gba-in-cpp/prep/" title="Voorbereiding Thuis" class="dd-item ">
        <a href="../../gba-in-cpp/prep/">
        Voorbereiding Thuis
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/gba-in-cpp/labo-8/" title="Labo 8: GBA Programming in C&#43;&#43;: een abstractielaag" class="dd-item ">
        <a href="../../gba-in-cpp/labo-8/">
        Labo 8: GBA Programming in C&#43;&#43;: een abstractielaag
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/gba-in-cpp/labo-9/" title="Labo 9: GBA Programming in C&#43;&#43;: scrolling backgrounds" class="dd-item ">
        <a href="../../gba-in-cpp/labo-9/">
        Labo 9: GBA Programming in C&#43;&#43;: scrolling backgrounds
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/gba-in-cpp/labo-10/" title="Labo 10: Een introductie in GUI ontwerp met C&#43;&#43; in Qt" class="dd-item ">
        <a href="../../gba-in-cpp/labo-10/">
        Labo 10: Een introductie in GUI ontwerp met C&#43;&#43; in Qt
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/gba-in-cpp/labo-11/" title="Labo 11: een GBA spel porten naar Qt" class="dd-item ">
        <a href="../../gba-in-cpp/labo-11/">
        Labo 11: een GBA spel porten naar Qt
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/extra/" title="5. Extras" class="dd-item 
        
        
        
        ">
      <a href="../../extra/">
          5. Extras
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            




 
  
    
      <li data-nav-id="/extra/project/" title="Project opdracht" class="dd-item ">
        <a href="../../extra/project/">
        Project opdracht
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/extra/cheatsheet/" title="C Cheat Sheet" class="dd-item ">
        <a href="../../extra/cheatsheet/">
        C Cheat Sheet
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/extra/buildsystems/" title="Een introductie in C(&#43;&#43;) Build Systemen" class="dd-item ">
        <a href="../../extra/buildsystems/">
        Een introductie in C(&#43;&#43;) Build Systemen
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/extra/faq/" title="FAQ" class="dd-item ">
        <a href="../../extra/faq/">
        FAQ
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/extra/installaties/" title="Installatieinstructies" class="dd-item ">
        <a href="../../extra/installaties/">
        Installatieinstructies
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/extra/poll/" title="Poll: Ben ik klaar voor mijn examen?" class="dd-item ">
        <a href="../../extra/poll/">
        Poll: Ben ik klaar voor mijn examen?
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
         
    </ul>

    
    
      <section id="shortcuts">
        <h3>More</h3>
        <ul>
          
              <li> 
                  <a class="padding" href="https://www.uhasselt.be/studiegids"><i class='fa fa-university'></i> ECTS Sheet</a>
              </li>
          
              <li> 
                  <a class="padding" href="https://toledo.kuleuven.be/portal/"><i class='fa fa-university'></i> Toledo</a>
              </li>
          
        </ul>
      </section>
    

    
    <section id="footer">
      <p>Built with <a href="https://github.com/matcornic/hugo-theme-learn"><i class="fas fa-heart"></i></a> from <a href="https://getgrav.org">Grav</a> and <a href="https://gohugo.io/">Hugo</a></p>

    </section>
  </div>
</nav>




        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fas fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fas fa-list-alt"></i></span>
                  
                  <span class="links">
                 
                 
                    
          
          
            
            
          
          
            
            
          
          
            <a href='../../'>Software ontwerp in C/C++</a> > <a href='../../gba-in-c/'>2. GBA programming in C</a> > Labo 3: Introductie in GBA Programming
          
        
          
        
          
        
                 
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#gba-programming-een-introductie">GBA Programming: een introductie</a>
<ul>
<li><a href="#het-geheugen-layout-van-de-gba">Het geheugen layout van de GBA</a></li>
<li><a href="#display-setup">Display setup</a></li>
<li><a href="#simpele-display-manipulatie">Simpele display manipulatie</a></li>
</ul></li>
<li><a href="#keypad-input">Keypad input</a></li>
<li><a href="#compileren-voor-de-gba">Compileren voor de GBA</a>
<ul>
<li><a href="#de-cross-compiler">De cross-compiler</a>
<ul>
<li><a href="#ubuntu-specifieke-installatie">Ubuntu specifieke installatie</a></li>
</ul></li>
<li><a href="#je-gba-file-emuleren-op-pc">Je GBA file emuleren op PC</a></li>
<li><a href="#je-gba-file-spelen-op-een-echte-gameboy">Je GBA file spelen op een echte Gameboy</a></li>
</ul></li>
<li><a href="#bits-en-bytes-beter-begrijpen-in-c">Bits en bytes beter begrijpen in C</a></li>
<li><a href="#a-name-oef-a-labo-oefeningen"><a name="oef"></a>Labo oefeningen</a></li>
<li><a href="#denkvragen">Denkvragen</a></li>
</ul></li>
</ul>
</nav>
    </div>
</div>

                
              </div>
            </div>
            
        <div id="head-tags">
        
        </div>
        
        <div id="body-inner">
          
            <h1>
              
              Labo 3: Introductie in GBA Programming
            </h1>
          

        




<p>Je hebt nu een crashcrusus C achter de kiezen met een grondige focus op pointers. Hoog tijd om die kennis om te zetten in iets concreet én plezant. We gaan een héél simpel Gameboy Advance (GBA) spel ontwikkelen.</p>

<p>De GBA is een goede keuze om de kracht (en zwakheden) van C te demonstreren. Er is immers géén besturingsyssteem aanwezig. Er zijn géén libraries aanwezig voor memory management, IO, files, error handling, &hellip; Het is een embedded hardware systeem dat een <em>cross-compiler</em> vereist: een compiler op onze PC&rsquo;s dat compileert voor een ander platform en CPU, namelijk een 32-bit <a href="https://en.wikipedia.org/wiki/ARM_architecture">ARM</a> op 16.78 Mhz.</p>

<p><center>
    <img src="../../img/teaching/cpp/gba.jpg" class="bordered" /><br/>
    Het resultaat van veel hard werk in C (en Assemly)&hellip;
</center></p>

<h2 id="gba-programming-een-introductie">GBA Programming: een introductie</h2>

<p>Om eender wat gedaan te krijgen op een GBA zullen we alles met <a href="https://en.wikipedia.org/wiki/Memory-mapped_I/O">memory-mapped IO</a> moeten doen, door rechtstreeks bits weg te schrijven in geheugenadressen die zaken als het scherm, knoppen en het geluid voorstellen. Er is niet eens een <code>printf()</code> functie! In de plaats daarvan moeten we &ldquo;hello world&rdquo; tekenen op het scherm, wat véél meer werk vereist.</p>

<p>Programmeren op een extern systeem brengt véél hardwarematige complexiteit met zich mee. We gaan hier niet alles behandelen. De geïnteresseerden kunnen hier terecht voor meer diepgaande tutorials:</p>

<ul>
<li><a href="http://www.loirak.com/gameboy/gbatutor.php">http://www.loirak.com/gameboy/gbatutor.php</a></li>
<li><a href="https://www.coranac.com/tonc/text/first.htm">https://www.coranac.com/tonc/text/first.htm</a></li>
</ul>

<p>Laten we het eenvoudigste eerst proberen: de achtergrond te kleuren.</p>

<h3 id="het-geheugen-layout-van-de-gba">Het geheugen layout van de GBA</h3>

<p>Een duidelijk zicht op I/O adressen en hun functie zijn belangrijk. Adressen vallen in een range, afhankelijk van de grootte van het geheugen van elk systeem. Hieronder een kort overzicht (<a href="https://www.reinterpretcast.com/writing-a-game-boy-advance-game">bron</a>):</p>

<ol>
<li><code>0x00000000 - 0x00003FFF</code> - 16 KB System ROM (executable, but not readable)</li>
<li><code>0x02000000 - 0x02030000</code> - 256 KB EWRAM (general purpose RAM external to the CPU)</li>
<li><code>0x03000000 - 0x03007FFF</code> - 32 KB IWRAM (general purpose RAM internal to the CPU)</li>
<li><code>0x04000000 - 0x040003FF</code> - I/O Registers</li>
<li><code>0x05000000 - 0x050003FF</code> - 1 KB Colour Palette RAM</li>
<li><code>0x06000000 - 0x06017FFF</code> - 96 KB VRAM (Video RAM)</li>
<li><code>0x07000000 - 0x070003FF</code> - 1 KB OAM RAM (Object Attribute Memory — discussed later)</li>
<li><code>0x08000000 - 0x????????</code> - Game Pak ROM (0 to 32 MB)</li>
<li><code>0x0E000000 - 0x????????</code> - Game Pak RAM</li>
</ol>

<h3 id="display-setup">Display setup</h3>

<p>Er zijn 6 verschillende &ldquo;Video Modes&rdquo; beschikbaar die je moet aan- of uitzetten voordat je iets kan tekenen op het scherm. De GBA ondersteunt tilesets om sprites efficiënter te tekenen (de 3 laatste modes), maar wij hebben voorlopig genoeg aan pixel per pixel de kleur te zetten (de 3 eerste modes). De eenvoudigste mode zonder buffering is <strong>video mode 3</strong>. Dit heeft een resolutie van 240x160. Elke pixel RGB waardes om aan te spreken.</p>

<p>Naast mode 3 moeten we ook een &ldquo;Background mode&rdquo; kiezen. Er zijn 4 achtergrond lagen beschikbaar die het mogelijk maken om een 3D illusie te creëren door laag per laag te tekenen. BG mode 2 volstaat voorlopig.</p>

<p>De video parameters worden weggeschreven in controleregister <code>0x4000000</code>. De combinatie van BG2 en Mode3 kunnen we met een bitwise operator <code>|</code> samen plakken, maar je kan evengoed de bits apart manipuleren. Om de cryptische registers wat te verduidelijken gebruiken we preprocessor defines.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C"><span style="color:#75715e">#define MODE3 0x0003
</span><span style="color:#75715e">#define BG2 0x0400
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">volatile</span> <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>display_control <span style="color:#f92672">=</span> (<span style="color:#66d9ef">volatile</span> <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span><span style="color:#f92672">*</span>) <span style="color:#ae81ff">0x4000000</span>;

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>() {
    <span style="color:#f92672">*</span>display_control <span style="color:#f92672">=</span> MODE3 <span style="color:#f92672">|</span> BG2;
}</code></pre></div>
<p>Zie <a href="https://www.cs.rit.edu/~tjh8300/CowBite/CowBiteSpec.htm">Hardware Specifications</a> documentatie.</p>

<p>Wat doet die <code>volatile</code> daar? Dit zijn low-level registeradressen die op eender welk moment door de hardware zelf veranderd kunnen worden. Het volatile keyword zegt tegen de compiler dat dit stukje code niet geoptimaliseerd mag worden. De compiler kan anders nog beslissen om instructies van volgorde te wisselen met vreemde werking tot gevolg.</p>

<h3 id="simpele-display-manipulatie">Simpele display manipulatie</h3>

<p>De vereiste display setup is gebeurd, laten we wat pixels wegschrijven in het scherm register op <code>0x6000000</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C"><span style="color:#75715e">#define WIDTH 240
</span><span style="color:#75715e">#define HEIGHT 160
</span><span style="color:#75715e"></span><span style="color:#66d9ef">volatile</span> <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">short</span> <span style="color:#f92672">*</span>vram <span style="color:#f92672">=</span> (<span style="color:#66d9ef">volatile</span> <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">short</span><span style="color:#f92672">*</span>) <span style="color:#ae81ff">0x6000000</span>;

vram[<span style="color:#ae81ff">80</span><span style="color:#f92672">*</span>WIDTH <span style="color:#f92672">+</span> <span style="color:#ae81ff">115</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x001F</span>; <span style="color:#75715e">// 000000000011111 = R
</span><span style="color:#75715e"></span>vram[<span style="color:#ae81ff">80</span><span style="color:#f92672">*</span>WIDTH <span style="color:#f92672">+</span> <span style="color:#ae81ff">120</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x03E0</span>; <span style="color:#75715e">// 000001111100000 = G
</span><span style="color:#75715e"></span>vram[<span style="color:#ae81ff">80</span><span style="color:#f92672">*</span>WIDTH <span style="color:#f92672">+</span> <span style="color:#ae81ff">125</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x7C00</span>; <span style="color:#75715e">// 111110000000000 = B
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">while</span>(<span style="color:#ae81ff">1</span>);</code></pre></div>
<p>Prachtig, een rode, groene en blauwe pixel opgelicht!</p>

<p>VRAM is een (short, 16-bit) pointer naar een adres, om de X en Y coördinaten te bepalen gebruiken we een formule <code>vram[X*WIDTH +Y]</code>. De oneindige lus zorgt er voor dat het spel niet plots &ldquo;stopt&rdquo; - vergeet niet dat er geen OS is, dus zo&rsquo;n gevaarlijke code moet zelfs op de GBA.</p>

<p>Kleuren worden voorgesteld als een aaneenschakeling van binaire nummers. Het aantal bits geeft ons een idee hoeveel unieke kleuren we hebben. De originele Gameboy had 2 bits: zwart, wit, en twee schakeringen van grijs tussenin (<code>00</code>, <code>01</code>, <code>10</code>, <code>11</code>). De GBA heeft er 15 (1 bit ongebruikt), met 5 bits per interval:</p>

<script defer src="../../mermaid/mermaid.min.js">
	mermaid.initialize({
		startOnLoad: true,
		flowchart: {
			useMaxWidth: true
		}
	});
</script>
<div class="mermaid" align="center" >
	
graph LR;
    A[--] --- B[B]
    B --- C[B]
    C --- D[B]
    D --- E[B]
    E --- F[B]
    F --- G[G]
    G --- H[G]
    H --- I[G]
    I --- J[G]
    J --- K[G]
    K --- L[R]
    L --- M[R]
    M --- N[R]
    N --- O[R]
    O --- P[R]
    style B stroke:blue
    style C stroke:blue
    style D stroke:blue
    style E stroke:blue
    style F stroke:blue
    style G stroke:green
    style H stroke:green
    style I stroke:green
    style J stroke:green
    style K stroke:green
    style L stroke:red
    style M stroke:red
    style N stroke:red
    style O stroke:red
    style P stroke:red

</div>

<p>Hexadecimale kleuren tekenen is onbegonnen werk natuurlijk, laten we een functie maken die de juiste bits shift afhankelijk van een R,G,B waarde van 0 tot 31 (<code>unsigned int</code>):</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C"><span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">short</span> <span style="color:#a6e22e">color</span>(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> r, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> g, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> b) {
    <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">short</span> c <span style="color:#f92672">=</span> (b <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x1f</span>) <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">10</span>;
    c <span style="color:#f92672">|=</span> (g <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x1f</span>) <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">5</span>;
    c <span style="color:#f92672">|=</span> (r <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x1f</span>);
    <span style="color:#66d9ef">return</span> c;
}</code></pre></div>
<p><code>Ox1f</code> verzekert 5-bits (<code>11111</code> binair), met eerst blauw, dan groen en dan rood op de juiste plaats geshift. 240x160 = 38.400 kleuren x 16-bit = 614.400 bits / 8 = 76.800 bytes. Adres <code>0x6000000</code> gaat dus tot <code>0x6012c00</code>.</p>

<p>Om niet altijd het adres rechtstreeks aan te spreken met de breedte berekening, wrappen we dat ook nog in een functie:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C"><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">set_pixel</span>(<span style="color:#66d9ef">int</span> x, <span style="color:#66d9ef">int</span> y, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">short</span> color) {
    vram[x<span style="color:#f92672">*</span>WIDTH <span style="color:#f92672">+</span> y] <span style="color:#f92672">=</span> color;
}</code></pre></div>
<p>Een loop over X en Y waardes van het scherm zorgt voor een vrolijke kleur op je Gameboy scherm. <a href="../../teaching/cpp/labo-3-gbabg.c">Download het labo-3-gbabg.c hier</a>. Merk op dat dit pushen van pixel per pixel natuurlijk erg inefficiënt is: daarvoor zijn de tile video modes 0, 1 en 2.</p>

<p>Dit is wat je te zien krijgt:</p>

<p><center>
    <img src="../../img/teaching/cpp/mgba_output.png" class="bordered" />
</center></p>

<h2 id="keypad-input">Keypad input</h2>

<p>Oké, we hebben en &ldquo;spel&rdquo; geschreven met een blauwe achtergrond. Hoe passen we dit aan afhankelijk van een bepaalde toetsencombinatie? Volgens de GBA Keypad input <a href="http://www.akkit.org/info/gbatek.htm#gbakeypadinput">specificaties</a> moeten we hiervoor IO register <code>0x04000130</code> uitlezen.</p>

<p>Bit 6 staat bijvoorbeeld voor &ldquo;up&rdquo;. <a href="https://www.binaryhexconverter.com/binary-to-hex-converter">Geconverteerd van binary naar hex</a> levert <code>1000000</code>, ofwel <code>40</code> (dus <code>0x40</code>) op (6de bit op 1, beginnend vanaf bit nummer 0 in plaats van 1!). We kunnen key up dus definiëren als <code>#define KEY_UP 0x0040</code>. Je kan ook dynamisch 6 bits shiften: <code>#define KEY_UP (1 &lt;&lt; 6)</code>. Een derde mogelijkheid is in machten van 2 te werken (bits): <code>#define KEY_UP 64</code>.</p>

<p>Het is een goed idee om maar 1x tijdens de game loop alle key states uit te lezen. Een mask die alle input bits checkt is daarvoor nodig:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C"><span style="color:#75715e">#define KEY_ANY  0x03FF
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>() {
    <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> keys;
    <span style="color:#66d9ef">while</span>(<span style="color:#ae81ff">1</span>) {
        keys <span style="color:#f92672">=</span> <span style="color:#f92672">~*</span>key_input <span style="color:#f92672">&amp;</span> KEY_ANY;
        <span style="color:#75715e">// do stuff
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span>(keys <span style="color:#f92672">&amp;</span> KEY_UP) {
            <span style="color:#75715e">// do more stuff
</span><span style="color:#75715e"></span>        }
    }
}</code></pre></div>
<p>Merk de <code>~</code> op: het register bewaart de state omgekeerd.</p>

<h2 id="compileren-voor-de-gba">Compileren voor de GBA</h2>

<p>De gcc compiler kan je C programma ook compileren - het is tenslotte in de C taal geschreven. De register adressen verwijzen echter niet naar het juiste als je die binary op je PC wil uitvoeren, wat resulteert in &ldquo;Segmentation Fault&rdquo; waarschuwingen.</p>

<h3 id="de-cross-compiler">De cross-compiler</h3>

<p>De &ldquo;DevkitPro&rdquo; toolchain installeren levert je een aantal cross-compilers en linkers op die een C source file omzetten ine en GBA binary. Zie <a href="https://devkitpro.org/wiki/Getting_Started">installatie instructies</a> per OS. Via de meegeleverde package manager <code>pacman</code> kan je op OSX de package <code>gba-dev</code> installeren. Voor Windows is er een installer voorzien.</p>

<p>Je hebt 2 dingen nodig:</p>

<ol>
<li><code>arm-none-eabi-gcc</code>, de cross-compiler</li>
<li><code>arm-none-eabi-objcopy</code>, de linker</li>
</ol>

<p><a href="../../teaching/cpp/labo-3-gba.Makefile">Download een Makefile voor gba dev hier</a>. Pas je emulator pad en source bestandsnaam aan.</p>

<h4 id="ubuntu-specifieke-installatie">Ubuntu specifieke installatie</h4>

<p>Voor Ubuntu moet je eerst de devkitpro-pacman <code>.deb</code> file installeren die je <a href="https://github.com/devkitPro/pacman/releases">hier op Github</a> kan vinden. Het <code>pacman</code> commando is dan het <code>dkp-pacman</code> commando om verwarring met <code>apt</code> te vermijden. Installeer alle gba dev tools met <code>sudo dkp-pacman -S gba-dev</code>. De compilers zijn dan geïnstalleerd in <code>/opt/devkitpro/devkitARM/bin</code> dus voeg die folder toe aan je <code>$PATH</code>.</p>

<h3 id="je-gba-file-emuleren-op-pc">Je GBA file emuleren op PC</h3>

<p>Compileren met een cross-compiler gaat, maar de binaries kan je nooit op een ander systeem draaien dan waarvoor het gecompileerd is - tenzij je dit emuleert. Een <code>.gba</code> binary kan je emuleren op de PC met <a href="https://mgba.io">mGBA</a>.</p>

<h3 id="je-gba-file-spelen-op-een-echte-gameboy">Je GBA file spelen op een echte Gameboy</h3>

<p>De aanschaf van een <a href="http://www.ezflash.cn/product/omega/">EZ-FLASH Omega</a> bord maakt het mogelijk om met microSD kaarten <code>.gba</code> roms in te laden op je Gameboy Advance. Zo&rsquo;n cartridges bestaan al jaren: vroeger was EZ-Flash IV en Supercard populair. Tegenwoordig kan je met een SD adapter files drag- en droppen.</p>

<p><center>
    <img src="../../img/teaching/cpp/gba_ezflash.png" class="bordered" />
</center></p>

<p>Het plastieken omhulsel open gevezen geeft zicht op het bord:</p>

<p><center>
    <img src="../../img/teaching/cpp/ezflash.jpg" class="bordered" />
</center></p>

<p>Dit is een deel van <a href="../../gba-in-c/labo-4">labo 4</a> op de eigenlijke hardware:</p>

<p><center>
    <img src="../../img/teaching/cpp/gba_labo3.gif" style="width: 75%" class="bordered" />
</center></p>

<p>Een EZ-FLASH Omega kaart kost ongeveer €30 op Ebay. Dit is uiteraard volledig vrijblijvend: een minimum vereiste is de werking van je creatie op een emulator. Een rom uitvoeren op de eigenlijke hardware kàn verrassend zijn; sommige emulatoren zijn flexibeler in werking.</p>

<h2 id="bits-en-bytes-beter-begrijpen-in-c">Bits en bytes beter begrijpen in C</h2>

<p>Om hexadecimale geheugenadressen en bit flags beter te begrijpen op de GBA moeten we ontdekken hoe bitwise operatoren, <code>sizeof()</code> en shifts werken in C. De implementatie van byte groottes wijzigt per computer maar is (bijna) altijd 8 bits: <code>00000000</code>. De GBA vereist vaak - zoals het definiëren van kleuren - 16 bits: 8x2. Die kracht van 2 is geen toeval in de binaire wereld. We gebruiken 3 types in zo&rsquo;n embedded systeem:</p>

<ol>
<li>8 bits: <code>typedef unsigned char uint8</code></li>
<li>16 bits: <code>typedef unsigned short uint16</code></li>
<li>32 bits: <code>typedef unsigned int uint32</code></li>
</ol>

<p>Elke individuele bit op <code>1</code> of op <code>0</code> zetten kan je doen met hulp van binaire of bitshift operatoren. Een 16-bit variabele kan in feite 16 individuele eigenschappen opslaan (die actief of inactief staan). In een moderne taal als Java, op een moderner besturingssysteem, speelt geheugengebruik op zo&rsquo;n niveau geen rol meer. Daar definiëren we voor praktische redenen gewoon 16 aparte <code>boolean</code> variabelen.</p>

<p>Op de GBA speelt geheugengebruik een zeer belangrijke rol en kunnen we met &ldquo;bit masks&rdquo; alle eigenschappen samen proppen in 2 bytes. Vergeet niet dat er bijvoorbeeld maar 96KB aan 16-bit VRAM beschikbaar is. De <a href="https://problemkaputt.de/gbatek.htm#gbamemorymap">technische GBA Memory Map</a> pagina geeft weer hoeveel geheugen er bij welk IO adres beschikbaar is.</p>

<p><a href="../../teaching/cpp/labo-3-bits.c">Download het voorbeeldprogramma hier</a> om wat te experimenteren met deze gegevens. <a href="https://www.binaryhexconverter.com/hex-to-binary-converter">Hex naar Binary</a> converters en <a href="https://en.wikipedia.org/wiki/Bitwise_operations_in_C">Wikipedia</a> kunnen helpen.</p>
<pre><code>hoeveel bits zit er in ene byte hier? 8
sizeof BYTES unsigned short 2 - unsigned int BYTES: 4
sizeof BITS unsigned short 16 - unsigned int BITS: 32
sizeof arr8 uint32: 32

key right (1 &lt;&lt; 4):             0000 0000 0001 0000
key right na nog 1 bitshift:    0000 0000 0010 0000
opgeteld met bitwise OR |:      0000 0000 0011 0000
inverse met bitwise ~:          1111 1111 1100 1111

x mask:                         0000 0001 1111 1111
y mask:                         0000 0000 1111 1111</code></pre>
<h2 id="a-name-oef-a-labo-oefeningen"><a name="oef"></a>Labo oefeningen</h2>

<ol>
<li>Vorm het voorbeeld in de tekst om naar een &ldquo;hi!&rdquo; hello world applicatie. Teken de symbolen per pixel. <a href="../../teaching/cpp/labo-3-gbabg.c">Download het labo-3-gbabg.c hier</a>. <a href="../../teaching/cpp/labo-3-gba.Makefile">Download een Makefile voor gba dev hier</a>. Probeer eerst het bestaande te compileren met <code>make</code>.</li>
<li>Laten we het iets dynamischer maken. Lees het key input register in en maak gebruik van de pijltjes om je &ldquo;hi!&rdquo; tekst te verschuiven. Wat een spannend spel is dit aan het worden! Definiëer het input register op exact dezelfde manier als <code>vram</code> in de tekst.</li>
</ol>

<h2 id="denkvragen">Denkvragen</h2>

<ol>
<li>Waarom denk je dat Video mode 3 inefficiënt is? Kan je een alternatief verzinnen en dit vergelijken met mode 3 in termen van werking?</li>
<li>Nu je gezien hebt hoe we iets compileren voor een andere architectuur (<code>ARM</code> en niet <code>x86</code>), kan je ook een definitie geven van een <em>embedded system</em>? Hoe past een cross-compiler in dat plaatje?</li>
<li>Wat gebeurt er met de output van het x en y mask als je in het bits voorbeeldprogramma in main <code>uint16 nr;</code> herdefiniëert als een <code>uint8</code>? Kunnen we dit om geheugen te besparen overal toepassen?</li>
</ol>


<footer class="footline">
	
</footer>

        
        </div> 
        

      </div>

    <div id="navigation">
        
        
        
        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        
        
        


	 
	 
		
			<a class="nav nav-prev" href="../../gba-in-c/prep/" title="Voorbereiding Thuis"> <i class="fa fa-chevron-left"></i></a>
		
		
			<a class="nav nav-next" href="../../gba-in-c/labo-4/" title="Labo 4: GBA Tilesets, een simpel spel" style="margin-right: 0px;"><i class="fa fa-chevron-right"></i></a>
		
	
    </div>

    </section>
    
    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="../../js/clipboard.min.js?1602585869"></script>
    <script src="../../js/perfect-scrollbar.min.js?1602585869"></script>
    <script src="../../js/perfect-scrollbar.jquery.min.js?1602585869"></script>
    <script src="../../js/jquery.sticky.js?1602585869"></script>
    <script src="../../js/featherlight.min.js?1602585869"></script>
    <script src="../../js/highlight.pack.js?1602585869"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="../../js/modernizr.custom-3.6.0.js?1602585869"></script>
    <script src="../../js/learn.js?1602585869"></script>
    <script src="../../js/hugo-learn.js?1602585869"></script>

    <link href="../../mermaid/mermaid.css?1602585869" rel="stylesheet" />
    <script src="../../mermaid/mermaid.js?1602585869"></script>
    <script>
        mermaid.initialize({ startOnLoad: true });
    </script>
    

  </body>
</html>

